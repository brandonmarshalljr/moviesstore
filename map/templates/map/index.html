{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="p-3">
  <div class="container">
    <div class="row mt-3">
      <div class="col mx-auto mb-3">
        <h2>US States Map</h2>
        <hr />
        <p class="text-muted mb-1">We’ll try to center on your location (you’ll be prompted). If blocked, the map stays zoomed to the US.</p>
      </div>
    </div>
    <div class="row">
      <div class="col-12">
        <div id="map" class="w-100 rounded border" style="height:70vh;"></div>
      </div>
    </div>
  </div>
</div>
 
<!-- Leaflet CSS/JS (CDN) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
 
<script>
  // --- Base map (start on the US)
  const map = L.map('map', { zoomControl: true }).setView([39.8, -98.6], 4);
 
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19, attribution: '&copy; OpenStreetMap'
  }).addTo(map);
 
  // --- Try to locate user (works on HTTPS or http://localhost)
  function onLocateSuccess(pos) {
    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;
    const acc = pos.coords.accuracy; // meters
 
    // Center + zoom in
    map.setView([lat, lng], 12, { animate: true });
 
    // "You are here" marker
    const you = L.marker([lat, lng]).addTo(map)
      .bindPopup(`<strong>You are here</strong><br/>(~${Math.round(acc)}m accuracy)`)
      .openPopup();
 
    // Accuracy circle
    L.circle([lat, lng], { radius: acc }).addTo(map);
  }
 
  function onLocateError(err) {
    // Keep US view; optionally show a subtle hint in console
    console.warn('Geolocation unavailable/denied:', err && err.message);
  }
 
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(onLocateSuccess, onLocateError, {
      enableHighAccuracy: true,
      timeout: 8000,
      maximumAge: 30000,
    });
  } else {
    console.warn('Geolocation not supported by this browser.');
  }
 
  // --- Pins for all states + DC (placeholder popups)
  const stateCenters = [
    {code:'AL', name:'Alabama',      lat:32.806671, lng:-86.791130},
    {code:'AK', name:'Alaska',       lat:61.370716, lng:-152.404419},
    {code:'AZ', name:'Arizona',      lat:34.048928, lng:-111.093731},
    {code:'AR', name:'Arkansas',     lat:34.969704, lng:-92.373123},
    {code:'CA', name:'California',   lat:36.116203, lng:-119.681564},
    {code:'CO', name:'Colorado',     lat:39.059811, lng:-105.311104},
    {code:'CT', name:'Connecticut',  lat:41.597782, lng:-72.755371},
    {code:'DE', name:'Delaware',     lat:39.318523, lng:-75.507141},
    {code:'DC', name:'District of Columbia', lat:38.9072, lng:-77.0369},
    {code:'FL', name:'Florida',      lat:27.766279, lng:-81.686783},
    {code:'GA', name:'Georgia',      lat:33.040619, lng:-83.643074},
    {code:'HI', name:'Hawaii',       lat:21.094318, lng:-157.498337},
    {code:'ID', name:'Idaho',        lat:44.240459, lng:-114.478828},
    {code:'IL', name:'Illinois',     lat:40.349457, lng:-88.986137},
    {code:'IN', name:'Indiana',      lat:39.849426, lng:-86.258278},
    {code:'IA', name:'Iowa',         lat:42.011539, lng:-93.210526},
    {code:'KS', name:'Kansas',       lat:38.5266,   lng:-96.726486},
    {code:'KY', name:'Kentucky',     lat:37.66814,  lng:-84.670067},
    {code:'LA', name:'Louisiana',    lat:31.169546, lng:-91.867805},
    {code:'ME', name:'Maine',        lat:44.693947, lng:-69.381927},
    {code:'MD', name:'Maryland',     lat:39.063946, lng:-76.802101},
    {code:'MA', name:'Massachusetts',lat:42.230171, lng:-71.530106},
    {code:'MI', name:'Michigan',     lat:43.326618, lng:-84.536095},
    {code:'MN', name:'Minnesota',    lat:45.694454, lng:-93.900192},
    {code:'MS', name:'Mississippi',  lat:32.741646, lng:-89.678696},
    {code:'MO', name:'Missouri',     lat:38.456085, lng:-92.288368},
    {code:'MT', name:'Montana',      lat:46.921925, lng:-110.454353},
    {code:'NE', name:'Nebraska',     lat:41.12537,  lng:-98.268082},
    {code:'NV', name:'Nevada',       lat:38.313515, lng:-117.055374},
    {code:'NH', name:'New Hampshire',lat:43.452492, lng:-71.563896},
    {code:'NJ', name:'New Jersey',   lat:40.298904, lng:-74.521011},
    {code:'NM', name:'New Mexico',   lat:34.840515, lng:-106.248482},
    {code:'NY', name:'New York',     lat:42.165726, lng:-74.948051},
    {code:'NC', name:'North Carolina',lat:35.630066,lng:-79.806418},
    {code:'ND', name:'North Dakota', lat:47.528912, lng:-99.784012},
    {code:'OH', name:'Ohio',         lat:40.388783, lng:-82.764915},
    {code:'OK', name:'Oklahoma',     lat:35.565342, lng:-96.928917},
    {code:'OR', name:'Oregon',       lat:44.572021, lng:-122.070938},
    {code:'PA', name:'Pennsylvania', lat:40.590752, lng:-77.209755},
    {code:'RI', name:'Rhode Island', lat:41.680893, lng:-71.51178},
    {code:'SC', name:'South Carolina',lat:33.856892,lng:-80.945007},
    {code:'SD', name:'South Dakota', lat:44.299782, lng:-99.438828},
    {code:'TN', name:'Tennessee',    lat:35.747845, lng:-86.692345},
    {code:'TX', name:'Texas',        lat:31.054487, lng:-97.563461},
    {code:'UT', name:'Utah',         lat:40.150032, lng:-111.862434},
    {code:'VT', name:'Vermont',      lat:44.045876, lng:-72.710686},
    {code:'VA', name:'Virginia',     lat:37.769337, lng:-78.169968},
    {code:'WA', name:'Washington',   lat:47.400902, lng:-121.490494},
    {code:'WV', name:'West Virginia',lat:38.491226, lng:-80.954453},
    {code:'WI', name:'Wisconsin',    lat:44.268543, lng:-89.616508},
    {code:'WY', name:'Wyoming',      lat:42.755966, lng:-107.30249},
  ];
 
  /*stateCenters.forEach(s => {
    L.marker([s.lat, s.lng])
      .addTo(map)
      .bindPopup(`<strong>${s.name} (${s.code})</strong><br/>Placeholder: trending info coming soon.`);
  });*/
  stateCenters.forEach((s) => {
    const marker = L.marker([s.lat, s.lng]).addTo(map);
    marker.bindPopup(`<strong>${s.name} (${s.code})</strong><br/>Loading…`);

    marker.on('click', async () => {
      try {
        const url = "{% url 'map.top_by_state' %}" + "?state=" + encodeURIComponent(s.code);
        const res = await fetch(url);
        if (!res.ok) {
          marker.setPopupContent(`<strong>${s.name} (${s.code})</strong><br/>HTTP ${res.status} loading data.`);
          return;
        }
        const data = await res.json();

        let body;
        if (data.top) {
          const note = data.fallback ? `<br><small class="text-muted">(Global top, no data for this state)</small>` : "";
          body = `<em>Top movie</em><br>${data.top.name} — ${data.top.count}${note}`;
        } else {
          body = "No data yet.";
        }

        marker.setPopupContent(`
          <strong>${s.name} (${s.code})</strong><br/>
          ${body}
        `).openPopup();
      } catch (e) {
        marker.setPopupContent(`<strong>${s.name} (${s.code})</strong><br/>Network error.`);
      }
    });
  });
</script>
{% endblock content %}